#Lists of known integrations must be provided in BED format (tab-delimited chromosome, start and end positions). 
#Filtering based on reads should be adjusted depending on number of columns in known integration BED files.
#Known transposable element sites (based on reference) can be found with RepeatMasker (http://www.repeatmasker.org/).

#CONVERT BAM to BED
bedtools bamtobed -i mapped_trims.bam > mapped_trims.bed

#Mark number of mapped reads around known integration sites (works for reference and/or non-reference)
bedtools window -w 100 -c -a list_of_known_integration_sites.bed -b mapped_trims.bed > readCount_trims.bed

#Optional marking of either present or absent (after marking number of reads). Here the sixth column ($6) indicates the number of reads. To change threshold for calling presence/absence change ("$6 >= number").
awk '{if ($6>=5) $6="+"; else ($6="-"); print($1"\t"$2"\t"$3"\t"$4"\t"$5"\t"$6);}' readCount_trims.bed > pA_trims.bed

#SEARCH FOR DE NOVO INTEGRATIONS
bedtools window -w 2000 -v -a mapped_trims.bed -b list_of_known_integration_sites.bed| bedtools merge -c 4 -o count -d 1000 -i - > novel_integrations.bed

#Filter de novo candidates with minimum threshold ("$4 >= number")
bedtools window -w 2000 -v -a mapped_trims.bed -b list_of_known_integration_sites.bed| bedtools merge -c 4 -o count -d 1000 -i - | awk '{if ($4 >=5) print($0);}'- > filtered_novel_ints.bed
